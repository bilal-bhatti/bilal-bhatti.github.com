<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>K3S on LXC &ndash; Bilal Bhatti</title><meta name=description property="og:description" content="Setup a K3S cluster on single machine using LXC and K3S distribution.|Describe what your web page is about"><meta name=apple-mobile-web-app-title content="Bilal Bhatti"><link rel=icon href=/favicon-64.png><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=mask-icon size=any href=/pinned-icon.svg><meta name=twitter:card content="summary"><meta name=twitter:site content="@bilalwala"><meta name=twitter:creator content="@bilalwala"><meta name=twitter:title content="K3S on LXC | Bilal Bhatti"><meta name=twitter:description content="Setup a K3S cluster on single machine using LXC and K3S distribution.|Describe what your web page is about"><meta name=twitter:image content="https://bilal-bhatti.github.io/twitter-card.png"><link rel=stylesheet href=/assets/syntax.css><link rel=stylesheet href=/assets/primer-build.css><link rel=stylesheet href=/assets/style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://bilal-bhatti.github.io/>Bilal Bhatti</a></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">K3S on LXC</div></div><div class=Subhead-description><a href=/tags/docker class=muted-link><span class="Label Label--gray">docker</span></a>
<a href=/tags/kubernetes class=muted-link><span class="Label Label--gray">kubernetes</span></a>
<a href=/tags/k3s class=muted-link><span class="Label Label--gray">k3s</span></a><div class=float-md-right><span title="Lastmod: 2019-10-23. Published at: 2019-10-23.">Published: 2019-10-23</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><p>Most other options for running a local K8S cluster are quiet resource intensive and aren&rsquo;t easy to configure and setup. I have this setup on an old computer with a Q6600 CPU and 4GB of ram. It let&rsquo;s me scale up the cluster to 5 worker nodes, without issues. It&rsquo;s no fun to have just a one node cluster.</p><h1 id=host-configuration>Host Configuration</h1><p>Assuming we start with a fresh install of Debian Buster on a physical machine.</p><h2 id=neworking>Neworking</h2><h3 id=configure-network-bridge>Configure Network Bridge</h3><p>We&rsquo;ll use systemd networkd service to create the bridge network, so update <code>/etc/network/interfaces</code> to only create the loopback network interface. When we configure LXC, we&rsquo;ll have it use this bridge, <code>br0</code>. Each LXC guest will retrieve it&rsquo;s own IP from the DHCP server.</p><p><code>vi /etc/network/interfaces</code><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># The loopback network interface</span>
auto lo
iface lo inet loopback</code></pre></div></p><p>Create bridge device
<code>vi /etc/systemd/networkd/br0.netdev</code><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>[</span>NetDev<span style=color:#f92672>]</span>
Name<span style=color:#f92672>=</span>br0
Kind<span style=color:#f92672>=</span>bridge
MACAddress<span style=color:#f92672>=</span>&lt;MAC address of your physical NIC&gt;</code></pre></div></p><p>Configure bridge device to use DHCP <code>vi /etc/systemd/networkd/br0.network</code><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>[</span>Match<span style=color:#f92672>]</span>
Name<span style=color:#f92672>=</span>br0

<span style=color:#f92672>[</span>Network<span style=color:#f92672>]</span>
DHCP<span style=color:#f92672>=</span>ipv4</code></pre></div></p><p>Configure your physical NIC device to use the bridge <code>vi /etc/systemd/networkd/enp2s0.network</code><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>[</span>Match<span style=color:#f92672>]</span>
Name<span style=color:#f92672>=</span>&lt;enp2s0, or whatever your NIC device name is&gt;

<span style=color:#f92672>[</span>Network<span style=color:#f92672>]</span>
Bridge<span style=color:#f92672>=</span>br0</code></pre></div></p><p>Enable and start systemd-netword service with:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>systemctl start systemd-networkd
systemctl enable systemd-networkd</code></pre></div></p><p>Running <code>networkctl</code> should give you this.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>networkctl
<span style=color:#75715e>#=&gt; IDX LINK             TYPE               OPERATIONAL SETUP</span>
<span style=color:#75715e>#=&gt;   1 lo               loopback           carrier     unmanaged</span>
<span style=color:#75715e>#=&gt;   2 enp2s0           ether              degraded    configured</span>
<span style=color:#75715e>#=&gt;   3 br0              bridge             routable    configured</span></code></pre></div></p><h2 id=additional-host-configuration>Additional Host Configuration</h2><p>Install lxd and some other networking tools.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>apt install ebtables ethtool conntrack snapd -y
snap install lxd <span style=color:#75715e># install version of lxd provided by canonical through snap</span></code></pre></div></p><p>K3S/K8S requires that we disable swap on the system, so we disable it and comment out the entry in <code>/etc/fstab</code>. As root run:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>swapoff -a</code></pre></div></p><p>Enable IP forwarding rule in <code>vi /etc/sysctl.conf</code>.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>net.ipv4.ip_forward <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span></code></pre></div></p><p>Add this to crontab to run at boot with <code>crontab -e</code> as root</p><p><strong><em>The <code>32768</code> number will depend on your system configuration, so it might be different. Later on in the process if <code>coredns</code> pod fails to start, check the logs and you will see an error indicating it fails to write a value to <code>nf_conntrack/parameters/hashsize</code>. That value is what you need in the command below.</em></strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>@reboot echo <span style=color:#e6db74>&#34;32768&#34;</span> &gt; /sys/module/nf_conntrack/parameters/hashsize</code></pre></div><p><em>REBOOT AND CHECK THE ABOVE SETTINGS ARE PERSISTENT</em></p><h2 id=configure-lxd>Configure LXD</h2><p>Before we create any LXC containers, we have to create or update <code>/etc/subuid</code> and <code>/etc/subgid</code> files with the following entries:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>root:1000000:1000000000
&lt;your username&gt;:1000000:1000000000</code></pre></div></p><p>Configure lxd, set it to use <code>br0</code> network bridge. Make sure to select <code>dir</code> as the storage backend.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>lxd init</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>Would you like to use LXD clustering? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>: 
Do you want to configure a new storage pool? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>yes<span style=color:#f92672>]</span>:
Name of the new storage pool <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>default<span style=color:#f92672>]</span>: 
Name of the storage backend to use <span style=color:#f92672>(</span>btrfs, ceph, dir, lvm<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>btrfs<span style=color:#f92672>]</span>: dir
Would you like to connect to a MAAS server? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>:
Would you like to create a new local network bridge? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>yes<span style=color:#f92672>]</span>: no
Would you like to configure LXD to use an existing bridge or host interface? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>: yes
Name of the existing bridge or host interface: br0
Would you like LXD to be available over the network? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>: yes
Address to bind LXD to <span style=color:#f92672>(</span>not including port<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>all<span style=color:#f92672>]</span>:
Port to bind LXD to <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span><span style=color:#ae81ff>8443</span><span style=color:#f92672>]</span>:
Trust password <span style=color:#66d9ef>for</span> new clients:
Again:
Would you like stale cached images to be updated automatically? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>yes<span style=color:#f92672>]</span>:
Would you like a YAML <span style=color:#e6db74>&#34;lxd init&#34;</span> preseed to be printed? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>:</code></pre></div></p><h3 id=create-base-container>Create Base Container</h3><p>We&rsquo;ll create a base container that we can later copy to start our master and worker nodes to save time and make sure they are all consistent.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>lxc launch images:debian/buster kbase-buster
lxc file push /boot/config-4.19.0-6-amd64 kbase-buster/boot/config-4.19.0-6-amd64</code></pre></div></p><p>Running Docker (K3S/Kubernetes) in Docker requires changes to grant the LXC guests additional privileges. Modify container configuration with <code>lxc config edit kbase-buster</code> with the following. This will setup the AppArmor profile to allow Docker in Docker, mount <code>/dev/kmsg</code> and <code>/lib/modules</code> and make them available to the guest containers.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>config:
  raw.lxc: <span style=color:#e6db74>&#34;lxc.apparmor.profile=unconfined\nlxc.cap.drop=\nlxc.cgroup.devices.allow=a\nlxc.mount.auto=proc:rw sys:rw cgroup:rw&#34;</span>
  security.nesting: <span style=color:#e6db74>&#34;true&#34;</span>
  security.privileged: <span style=color:#e6db74>&#34;true&#34;</span>
devices:
  devkmsg:
    path: /dev/kmsg
    source: /dev/kmsg
    type: unix-char
  libmodules:
    path: /lib/modules
    source: /lib/modules
    type: disk</code></pre></div></p><p>Next step is executed inside the container to install basic utilities. Connect to <code>kbase-buster</code> and install <code>apt-utils</code> as below.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>lxc exec kbase-buster /bin/bash
apt update
apt upgrade
apt install apt-utils</code></pre></div></p><p>At this point the base container is ready. In <strong><em>part 2</em></strong> of this guide we&rsquo;ll install and configure a 3 node K3S cluster and deploy a simple web application.</p><h1 id=references>References</h1><ul><li><a href=https://github.com/corneliusweig/kubernetes-lxd>https://github.com/corneliusweig/kubernetes-lxd</a></li><li><a href=https://github.com/charmed-kubernetes/bundle/wiki/Deploying-on-LXD>https://github.com/charmed-kubernetes/bundle/wiki/Deploying-on-LXD</a></li><li><a href=https://ubuntu.com/blog/running-kubernetes-inside-lxd>https://ubuntu.com/blog/running-kubernetes-inside-lxd</a></li></ul></section><section></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>K3S on LXC</b><nav id=TableOfContents><ul><li><a href=#host-configuration>Host Configuration</a><ul><li><a href=#neworking>Neworking</a><ul><li><a href=#configure-network-bridge>Configure Network Bridge</a></li></ul></li><li><a href=#additional-host-configuration>Additional Host Configuration</a></li><li><a href=#configure-lxd>Configure LXD</a><ul><li><a href=#create-base-container>Create Base Container</a></li></ul></li></ul></li><li><a href=#references>References</a></li></ul></nav></div><div><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"><span class="text-small text-gray">&copy;Bilal Bhatti 2019 &middot;
Powered by
<a href=https://gohugo.io class=link-gray-dark>Hugo</a> +
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a></span></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>